%LuaTeX

\definemixedcolumns[dialogue][balance=yes,
                              n=2,
                              ]

% \showgrid
\showframe
\showlayout

\setuphead[part][
  header=empty,
  placehead=yes,
  number=no,
]

\setuphead[section][
  page=no,
  number=no,
  before={\blank},
  after={},
  align=middle,
]

\setuppagenumbering[alternative=doublesided]

\definepapersize[memo][width=5.5in,height=8.5in]
\setuppapersize[memo,portrait][letter,landscape]
\setuparranging[2UP]

\startsetups[grid][widowsandorphans]
  \setdefaultpenalties
  \setpenalties\widowpenalties{2}{10000}
  \setpenalties\clubpenalties {2}{10000}
\stopsetups

\setuplayout[
  grid=yes,
  setups=widowsandorphans,
  width=4.5in,
  height=8in,
  backspace=.4in
]

\setupbodyfontenvironment[default][em=sc]
\definefontfeature[default][default][protrusion=quality,
                                      liga=yes,
                                      clig=yes,
                                      calt=yes,
                                      kern=yes,
                                      expansion=quality,
                                      mode=node,
                                      trep=yes,
                                      script=latn,
                                      onum=yes,
                                      dlig=yes,
                                      hist=yes,
                                      jalt=yes,
                                      clig=yes]
\setupalign [hanging,hz]
\setuptolerance[{horizontal,strict,stretch}] % To fix overfills
\setuphyphenmark[sign=â€‘]

\usetypescript[palatino]
\definetypeface[palatino][rm][serif][palatino][default][features=default]
\setupbodyfont[palatino, 9.5pt]

\setupcolumns[n=2]

\startxmlsetups xml:corderius:*
  \xmlsetsetup{\xmldocument}{*}{-}
  \xmlsetsetup{\xmldocument}{TEI.2|text|body|castList|castItem|sp|speaker|foreign|p|head|q}{xml:corderius:*}

  \xmlsetsetup{\xmldocument}{div[@type='colloquia']}{xml:corderius:colloquia}
  \xmlsetsetup{\xmldocument}{div[@type='colloquium']}{xml:corderius:colloquium}
  \xmlsetsetup{\xmldocument}{div[@type='book']}{xml:corderius:liber}
\stopxmlsetups

\xmlregisterdocumentsetup{corderius}{xml:corderius:*}

\startxmlsetups{xml:corderius:TEI.2}
  \xmlflush{#1}
\stopxmlsetups

\startxmlsetups{xml:corderius:text}
  \xmlflush{#1}
\stopxmlsetups

\startxmlsetups{xml:corderius:body}
  \xmlflush{#1}
\stopxmlsetups

\startxmlsetups{xml:corderius:colloquia}
  \xmlflush{#1}
\stopxmlsetups

\startxmlsetups{xml:corderius:liber}
  \startpart[
    title={\xmlfirst{#1}{/head}}
    ]
    \xmlall{#1}{/!head}
  \stoppart
\stopxmlsetups

\startxmlsetups{xml:corderius:colloquium}
  \startsection[
    title={\xmlfirst{#1}{/head}}
    ]
    %\xmlall{#1}{*[position()>1]}
    \xmlall{#1}{/p|castList}
    \startmixedcolumns[dialogue]
      \xmlall{#1}{/!(head|p|castList)}
    \stopmixedcolumns
  \stopsection
\stopxmlsetups

\startxmlsetups{xml:corderius:head}
  \xmlflush{#1}
\stopxmlsetups

\startxmlsetups{xml:corderius:castList}
  \xmlflush{#1}
  \blank
\stopxmlsetups

\startxmlsetups{xml:corderius:castItem}
  \xmlflush{#1}\space\space
\stopxmlsetups

\startxmlsetups{xml:corderius:sp}
  \xmlflush{#1}\endgraf
\stopxmlsetups

\startxmlsetups{xml:corderius:speaker}
  \xmlflush{#1}
\stopxmlsetups

\startxmlsetups{xml:corderius:p}
  \xmlflush{#1}
\stopxmlsetups

\startxmlsetups{xml:corderius:foreign}
  \xmlflush{#1}
\stopxmlsetups

\startxmlsetups{xml:corderius:q}
  \xmlflush{#1}
\stopxmlsetups

\starttext

  \xmlprocessfile{corderius}{liber_i.xml}{}

\stoptext
