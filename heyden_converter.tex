%LuaTeX

\usemodule[ntb-to-xtb]

\startxmlsetups xml:heyden:*
  \xmlsetsetup{\xmldocument}{*}{-}
  \xmlsetsetup{\xmldocument}{content|h1|section|spoken|tablerow|h2|head|en-head|speakers|p|en-p|page|skip|note|it}{xml:heyden:*}
\stopxmlsetups

\xmlregisterdocumentsetup{heyden}{xml:heyden:*}

\startxmlsetups{xml:heyden:content}
  \starttitle[title={\xmlfirst{#1}{h1}}]
    %\xmlflush{#1}
    \page
    \xmlall{#1}{section|page}
  \stoptitle
\stopxmlsetups

\startxmlsetups{xml:heyden:section}
  \startchapter[title={\xmlfirst{#1}{h2}}]
    \xmlall{#1}{!h2|!p|!en-p|!tablerow|!note|!it}
    %\xmlfilter{#1}{[position()>1]/all()}
  \stopchapter
\stopxmlsetups

\startxmlsetups{xml:heyden:head}
  \bigger{\xmlflush{#1}}\endgraf
\stopxmlsetups

\startxmlsetups{xml:heyden:en-head}
  {\it\xmlflush{#1}}\endgraf
  \bigskip
\stopxmlsetups

\startxmlsetups{xml:heyden:speakers}
  \xmlflush{#1}\endgraf
\stopxmlsetups

\startxmlsetups{xml:heyden:spoken}
  \starttabulate[|l|Il|]
  %\bTABLE
  %\startxtable%\bTABLE
    \xmlflush{#1}
  %\stopxtable%\eTABLE
  %\eTABLE
  \stoptabulate
\stopxmlsetups

\startxmlsetups{xml:heyden:tablerow}
  %\bTR
  %\startxrow%\bTR
    \xmlflush{#1}
  %\stopxrow%\eTR
  %\eTR
  \NR
\stopxmlsetups

\startxmlsetups{xml:heyden:p}
  \NC
  %\bTD
  %\startxcell%\bTD
    \xmlflush{#1}
  %\stopxcell%\eTD
  %\eTD
\stopxmlsetups

\startxmlsetups{xml:heyden:note}
  \footnote{\xmlflush{#1}}
\stopxmlsetups

\startxmlsetups{xml:heyden:it}
  {\it \xmlflush{#1}}
\stopxmlsetups

\startxmlsetups{xml:heyden:en-p}
  \NC
  %\bTD
  %\startxcell%\bTD
    \xmlflush{#1}
  %\stopxcell%\eTD
  %\eTD
\stopxmlsetups

\startxmlsetups{xml:heyden:page}
  \page[yes]
\stopxmlsetups

\startxmlsetups{xml:heyden:skip}
  %\vfill
  %\skip
\stopxmlsetups

\startxmlsetups{xml:heyden:h1}
  \xmlflush{#1}
\stopxmlsetups

\startxmlsetups{xml:heyden:h2}
  \xmlflush{#1}
\stopxmlsetups

\starttypescript [coelacanth,coelacanth-display]
% \definefontsynonym[Human readable]       [file:filename without extension]
  \definefontsynonym[coelacanth]           [file:Coelacanth]
  \definefontsynonym[coelacanthitalic]     [file:CoelacanthItalic]
  \definefontsynonym[coelacanthbold]       [file:CoelacanthBold]
  \definefontsynonym[coelacanthdisplaylight]    [file:CoelacanthDisplayLt]
\stoptypescript

\starttypescript [coelacanth,coelacanth-display]
  \setups[font:fallback:serif]
  \definefontsynonym[Serif]        [coelacanth]             [features=default]
  \definefontsynonym[SerifItalic]  [coelacanthitalic]       [features=default]
  \definefontsynonym[SerifBold]    [coelacanthbold]         [features=default]
  \definefontsynonym[DisplayLight] [coelacanthdisplaylight] [features=default]
\stoptypescript

\starttypescript [coelacanth]
  \definetypeface [coelacanth]    [rm] [serif] [coelacanth]    [default]
\stoptypescript

\setupbodyfont[coelacanth, 9pt]

% \setupbodyfont[palatino, 9pt]
%\setupTABLE[columndistance=.5in,split=yes,option=tight,align=lohi,frame=off]
%\setupTABLE[c][align={lohi,flushleft,hz},width=2in,offset=0em]
%\setupTABLE[c][2][style=\it]

%\setupxtable[columndistance=.5in,split=yes,option=tight,align=lohi,frame=off]
%\setupxtable[c][align={lohi,flushleft,hz},width=2in,offset=0em]
%\setupxtable[c][2][style=\it]
\setuphead[chapter][number=no,page=no,after=\smallskip,before=\bigskip]
\setuphead[title][align={middle,nothyphenated}]

\setupfootnotes[n=3]

\enablemode[booklet]
\environment /home/keiser/context/environments/doc_types.tex
\setuplayout[grid=no] % Remove if not using coelacanth

\starttext
  \xmlprocessfile{heyden}{puerilium_colloquiorum.xml}{}
\stoptext
